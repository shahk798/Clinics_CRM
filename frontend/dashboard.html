document.addEventListener("DOMContentLoaded", async () => {
  // ------------------ DASHBOARD LOGIC ------------------ //
  if (!localStorage.getItem("loggedIn")) {
    window.location.href = "login.html";
    return;
  }

  const logoutBtn = document.getElementById("logoutBtn");
  const addPatientBtn = document.getElementById("addPatientBtn");
  const modal = document.getElementById("patientModal");
  const form = document.getElementById("patientForm");
  const tableBody = document.querySelector("#patientTable tbody");
  const closeModal = document.getElementById("closeModal");
  const searchInput = document.getElementById("searchInput");
  const profileModal = document.getElementById("profileModal");
  const profileDetails = document.getElementById("profileDetails");
  const closeProfile = document.getElementById("closeProfile");

  const totalPatientsCard = document.getElementById("totalPatients");
  const completedAppointmentsCard = document.getElementById("completedAppointments");
  const pendingAppointmentsCard = document.getElementById("pendingAppointments");
  const cancelledAppointmentsCard = document.getElementById("cancelledAppointments");
  const totalRevenueCard = document.getElementById("totalRevenue");

  const clinicId = localStorage.getItem("clinicId");
  let patients = [];
  let editIndex = null;

  // --- Patient form inputs ---
  const pName = document.getElementById("pName");
  const pPhone = document.getElementById("pPhone");
  const pEmail = document.getElementById("pEmail");
  const pService = document.getElementById("pService");
  const pPrice = document.getElementById("pPrice");
  const pDate = document.getElementById("pDate");
  const pTime = document.getElementById("pTime");
  const pStatus = document.getElementById("pStatus");

  const BASE_URL = "https://clinics-crm.onrender.com"; // your backend URL on Render

  // ------------------ FETCH PATIENTS ------------------ //
  async function fetchPatients() {
    try {
      const res = await fetch(`${BASE_URL}/api/patients?clinicId=${clinicId}`);
      patients = await res.json();
      renderPatients();
    } catch (err) {
      console.error("Error fetching patients", err);
    }
  }

  // ------------------ RENDER PATIENTS ------------------ //
  function renderPatients(filteredData = patients) {
    tableBody.innerHTML = "";

    const totalPatients = filteredData.length;
    const completed = filteredData.filter(p => p.status === "Complete").length;
    const pending = filteredData.filter(p => p.status === "Pending").length;
    const cancelled = filteredData.filter(p => p.status === "Cancelled").length;
    const revenue = filteredData.reduce((sum, p) => p.status === "Complete" ? sum + Number(p.price) : sum, 0);

    totalPatientsCard.innerText = totalPatients;
    completedAppointmentsCard.innerText = completed;
    pendingAppointmentsCard.innerText = pending;
    cancelledAppointmentsCard.innerText = cancelled;
    totalRevenueCard.innerText = revenue;

    filteredData.forEach((p, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.name}</td>
        <td>${p.phone}</td>
        <td>${p.email}</td>
        <td>${p.service}</td>
        <td>₹${p.price}</td>
        <td>${p.date}</td>
        <td>${p.time}</td>
        <td class="status ${p.status}">${p.status}</td>
        <td>
          <div class="action-buttons">
            <button class="viewBtn" data-index="${index}">View</button>
            <button class="editBtn" data-index="${index}">Edit</button>
            <button class="deleteBtn" data-index="${index}">Delete</button>
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  await fetchPatients();

  // ------------------ MODALS ------------------ //
  addPatientBtn.addEventListener("click", () => {
    modal.style.display = "flex";
    form.reset();
    editIndex = null;
    document.getElementById("modalTitle").innerText = "Add Patient";
  });

  closeModal.addEventListener("click", () => modal.style.display = "none");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const patient = {
      name: pName.value,
      phone: pPhone.value,
      email: pEmail.value,
      service: pService.value,
      price: pPrice.value,
      date: pDate.value,
      time: pTime.value,
      status: pStatus.value,
      clinicId: clinicId
    };

    try {
      if (editIndex !== null) {
        await fetch(`${BASE_URL}/api/patients/${patients[editIndex]._id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patient)
        });
      } else {
        await fetch(`${BASE_URL}/api/patients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patient)
        });
      }
      modal.style.display = "none";
      await fetchPatients();
    } catch (err) {
      console.error("Error saving patient", err);
    }
  });

  tableBody.addEventListener("click", (e) => {
    const index = e.target.dataset.index;

    if (e.target.classList.contains("editBtn")) {
      editIndex = index;
      const p = patients[index];
      modal.style.display = "flex";
      document.getElementById("modalTitle").innerText = "Edit Patient";

      pName.value = p.name;
      pPhone.value = p.phone;
      pEmail.value = p.email;
      pService.value = p.service;
      pPrice.value = p.price;
      pDate.value = p.date;
      pTime.value = p.time;
      pStatus.value = p.status;
    }

    if (e.target.classList.contains("deleteBtn")) {
      if (confirm("Delete this patient?")) {
        fetch(`${BASE_URL}/api/patients/${patients[index]._id}`, { method: "DELETE" })
          .then(() => fetchPatients());
      }
    }

    if (e.target.classList.contains("viewBtn")) {
      const p = patients[index];
      profileDetails.innerHTML = `
        <p><strong>Name:</strong> ${p.name}</p>
        <p><strong>Phone:</strong> ${p.phone}</p>
        <p><strong>Email:</strong> ${p.email}</p>
        <p><strong>Service:</strong> ${p.service}</p>
        <p><strong>Price:</strong> ₹${p.price}</p>
        <p><strong>Date:</strong> ${p.date}</p>
        <p><strong>Time:</strong> ${p.time}</p>
        <p><strong>Status:</strong> ${p.status}</p>
      `;
      profileModal.style.display = "flex";
    }
  });

  closeProfile.addEventListener("click", () => profileModal.style.display = "none");

  // ------------------ SEARCH ------------------ //
  searchInput.addEventListener("input", () => {
    const value = searchInput.value.toLowerCase();
    const filtered = patients.filter(
      p => p.name.toLowerCase().includes(value) ||
           p.phone.includes(value) ||
           p.email.toLowerCase().includes(value)
    );
    renderPatients(filtered);
  });

  // ------------------ LOGOUT ------------------ //
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("clinicId");
    localStorage.removeItem("username");
    window.location.href = "login.html";
  });

  // ------------------ GENERATE PDF ------------------ //
  document.getElementById("reportBtn").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tableData = patients.map(p => [
      p.name, p.phone, p.email, p.service, `₹${p.price}`, p.date, p.time, p.status
    ]);

    doc.autoTable({
      head: [['Name', 'Phone', 'Email', 'Service', 'Price', 'Date', 'Time', 'Status']],
      body: tableData
    });

    doc.save(`clinic_${clinicId}_report.pdf`);
  });
});
